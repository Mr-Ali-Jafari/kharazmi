# راهنمای فنی کامل ابزار CodePrime

## فهرست مطالب
1. [معماری کلی سیستم](#معماری-کلی-سیستم)
2. [ماژول‌های اصلی](#ماژول‌های-اصلی)
3. [کلاس‌های اصلی](#کلاس‌های-اصلی)
4. [توابع کمکی](#توابع-کمکی)
5. [مدیریت خطا و امنیت](#مدیریت-خطا-و-امنیت)
6. [سیستم فونت فارسی](#سیستم-فونت-فارسی)
7. [مدیریت پروژه](#مدیریت-پروژه)
8. [هوش مصنوعی](#هوش-مصنوعی)
9. [بینایی کامپیوتر](#بینایی-کامپیوتر)
10. [همکاری آنلاین](#همکاری-آنلاین)

---

## معماری کلی سیستم

### ساختار فایل‌ها
```
main/
├── main.py                 # نقطه ورود اصلی
├── gui/
│   ├── gui.py             # رابط کاربری اصلی
│   ├── font_setup.py      # تنظیمات فونت
│   └── test_optimizations.py
├── core/
│   ├── ai_manager.py      # مدیریت هوش مصنوعی
│   ├── vision_manager.py  # مدیریت بینایی کامپیوتر
│   ├── framework_detector.py
│   ├── import_manager.py
│   └── project_organizer.py
├── cli/
│   └── cli.py             # رابط خط فرمان
└── server/
    └── main.py            # سرور همکاری
```

### الگوی طراحی
- **MVC Pattern**: جداسازی منطق، نمایش و کنترل
- **Thread-Safe Design**: استفاده از QThread برای عملیات سنگین
- **Error Handling**: مدیریت جامع خطاها
- **Resource Management**: مدیریت خودکار منابع

---

## ماژول‌های اصلی

### 1. ماژول GUI (`gui/gui.py`)

#### کلاس‌های اصلی:

##### `SafeMainWindow` (کلاس اصلی پنجره)
```python
class SafeMainWindow(QMainWindow):
```
**وظایف:**
- مدیریت پنجره اصلی برنامه
- ایجاد و مدیریت تب‌های مختلف
- مدیریت رویدادهای کلیدی
- تنظیم رابط کاربری

**متدهای مهم:**
- `__init__()`: مقداردهی اولیه
- `_init_ui()`: راه‌اندازی رابط کاربری
- `_create_all_tabs()`: ایجاد تمام تب‌ها
- `toggle_fullscreen()`: تغییر حالت تمام صفحه
- `closeEvent()`: مدیریت بستن برنامه

##### `SafeCodeEditor` (ویرایشگر کد)
```python
class SafeCodeEditor(QTextEdit):
```
**وظایف:**
- ویرایش کد با syntax highlighting
- تکمیل خودکار کد با AI
- مدیریت تغییرات
- ارسال تغییرات برای همکاری

**متدهای مهم:**
- `keyPressEvent()`: مدیریت کلیدهای فشرده شده
- `auto_complete()`: تکمیل خودکار کد
- `set_syntax_highlighting()`: تنظیم رنگ‌بندی کد

##### `SafePythonSyntaxHighlighter` (رنگ‌بندی کد)
```python
class SafePythonSyntaxHighlighter(QSyntaxHighlighter):
```
**وظایف:**
- رنگ‌بندی کلمات کلیدی Python
- تشخیص کامنت‌ها و رشته‌ها
- بهبود خوانایی کد

##### `SafeCollaborationClient` (کلاینت همکاری)
```python
class SafeCollaborationClient(QObject):
```
**وظایف:**
- اتصال به سرور WebSocket
- ارسال و دریافت تغییرات
- مدیریت اتصال مجدد
- همکاری زنده

**متدهای مهم:**
- `connect()`: اتصال به سرور
- `send_message()`: ارسال پیام
- `retry_connection()`: تلاش مجدد برای اتصال

##### `SafeFileManager` (مدیر فایل)
```python
class SafeFileManager:
```
**وظایف:**
- مدیریت فایل‌های پروژه
- کش کردن نتایج
- جستجوی فایل‌ها
- مدیریت thread-safe

### 2. ماژول Core

#### `ai_manager.py`
```python
class AIManager:
```
**وظایف:**
- ارتباط با API هوش مصنوعی
- پردازش درخواست‌ها
- مدیریت پاسخ‌ها

**متدهای مهم:**
- `get_ai_response()`: دریافت پاسخ از AI

#### `vision_manager.py`
```python
class VisionManager:
class VisionThread(QThread):
```
**وظایف:**
- تشخیص حرکات دست
- تایپ با حرکات
- مدیریت دوربین
- پردازش تصویر

**متدهای مهم:**
- `start_vision()`: شروع تشخیص
- `detect_key_press()`: تشخیص فشردن کلید
- `draw_keyboard()`: رسم کیبورد مجازی

#### `framework_detector.py`
```python
def detect_framework(project_path):
```
**وظایف:**
- تشخیص نوع فریم‌ورک پروژه
- پشتیبانی از Kivy, Flask, PyQt5, Pygame

#### `import_manager.py`
```python
def convert_imports_to_relative(project_path):
```
**وظایف:**
- تبدیل import های مطلق به نسبی
- بهبود ساختار پروژه

#### `project_organizer.py`
```python
def create_structure(project_path, framework):
def categorize_files(project_path):
```
**وظایف:**
- ایجاد ساختار پروژه
- دسته‌بندی فایل‌ها
- پیشنهاد ساختار مناسب

---

## کلاس‌های اصلی

### کلاس‌های Thread-Safe

#### `SafeAutoCompleteThread`
```python
class SafeAutoCompleteThread(QThread):
    finished = pyqtSignal(str)
    error_occurred = pyqtSignal(str)
```
**وظایف:**
- تکمیل خودکار کد در thread جداگانه
- جلوگیری از قفل شدن UI
- ارسال سیگنال‌های نتیجه

#### `SafeAskAIThread`
```python
class SafeAskAIThread(QThread):
    finished = pyqtSignal(str)
    error_occurred = pyqtSignal(str)
```
**وظایف:**
- پرسش از AI در thread جداگانه
- مدیریت پاسخ‌های طولانی
- جلوگیری از قفل شدن UI

### کلاس‌های مدیریت تب

هر تب دارای کلاس مدیریت مخصوص خود است:

#### تب About
- نمایش اطلاعات برنامه
- لینک‌های مفید
- اطلاعات توسعه‌دهنده

#### تب Terminal
- اجرای دستورات سیستم
- نمایش خروجی
- مدیریت خطاها

#### تب File Browser
- مرور فایل‌های پروژه
- باز کردن فایل‌ها
- نمایش ساختار پوشه‌ها

#### تب Code Editor
- ویرایش کد
- syntax highlighting
- تکمیل خودکار

#### تب Interpreter
- اجرای کد Python
- نمایش خروجی
- مدیریت خطاها

#### تب Task Manager
- مدیریت وظایف
- تنظیم مهلت
- پیگیری پیشرفت

#### تب Git
- مدیریت repository
- commit, push, pull
- نمایش وضعیت

#### تب AI
- پرسش از هوش مصنوعی
- دریافت پاسخ
- مدیریت API

#### تب Project Management
- مدیریت پروژه‌ها
- تشخیص فریم‌ورک
- پیشنهاد ساختار

#### تب Vision
- تشخیص حرکات دست
- تایپ با حرکات
- مدیریت دوربین

---

## توابع کمکی

### مدیریت خطا
```python
def global_exception_handler(exctype, value, traceback_obj):
```
**وظایف:**
- مدیریت خطاهای غیرمنتظره
- ثبت خطا در log
- نمایش پیام کاربری

### عملیات امن
```python
@contextmanager
def safe_operation(operation_name: str, default_return: Any = None):
```
**وظایف:**
- اجرای عملیات با مدیریت خطا
- بازگشت مقدار پیش‌فرض در صورت خطا
- ثبت خطاها

### تنظیم فونت فارسی
```python
def setup_persian_fonts(app: QApplication) -> str:
```
**وظایف:**
- تنظیم فونت‌های فارسی
- مدیریت fallback fonts
- پشتیبانی از RTL

---

## مدیریت خطا و امنیت

### سیستم Logging
```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('codeprime.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
```

### مدیریت خطا در کلاس‌ها
هر کلاس دارای:
- Try-catch blocks
- Error logging
- User-friendly error messages
- Recovery mechanisms

### Thread Safety
- استفاده از QMutex
- مدیریت race conditions
- Safe resource access

---

## سیستم فونت فارسی

### فونت‌های پشتیبانی شده
1. **Vazirmatn** - فونت مدرن فارسی
2. **B Nazanin** - فونت سنتی فارسی
3. **B Titr** - فونت نمایشی
4. **B Yekan** - فونت مدرن
5. **Tahoma** - پشتیبانی Windows
6. **Arial Unicode MS** - پشتیبانی Unicode

### تنظیمات
```python
persian_fonts = [
    'Vazirmatn', 'B Nazanin', 'B Titr', 'B Yekan',
    'B Mitra', 'B Lotus', 'B Traffic', 'Tahoma',
    'Arial Unicode MS', 'Segoe UI', 'sans-serif'
]
```

---

## مدیریت پروژه

### تشخیص فریم‌ورک
```python
def detect_framework(project_path):
    # تشخیص بر اساس فایل‌های موجود
    if any(file.endswith('.kv'): return "Kivy"
    elif 'app.py' in files: return "Flask"
    elif any(file.endswith('.ui'): return "PyQt5"
    elif 'pygame' in code: return "Pygame"
```

### ساختار پیشنهادی
```python
structures = {
    "Kivy": ["views/", "controllers/", "models/"],
    "Pygame": ["assets/", "sprites/", "events/"],
    "PyQt5": ["ui/", "controllers/", "models/"],
    "Flask": ["routes/", "templates/", "models/"]
}
```

### دسته‌بندی فایل‌ها
```python
categories = {
    "views": [".kv", ".html", ".ui"],
    "controllers": ["_controller.py", "controller.py"],
    "models": ["_model.py", "model.py"],
    "assets": [".png", ".jpg", ".svg"]
}
```

---

## هوش مصنوعی

### کلاس AIManager
```python
class AIManager:
    def __init__(self, api_key: str, base_url: str):
        self.api_key = api_key
        self.base_url = base_url
        self.system_message = "پیام سیستم..."
```

### ویژگی‌ها
- **API Integration**: ارتباط با OpenAI API
- **Custom Base URL**: پشتیبانی از سرورهای مختلف
- **System Messages**: تنظیم رفتار AI
- **Error Handling**: مدیریت خطاهای API

### استفاده
```python
ai_manager = AIManager(api_key="your_key")
response = ai_manager.get_ai_response("سوال شما")
```

---

## بینایی کامپیوتر

### کلاس VisionManager
```python
class VisionManager:
    def __init__(self):
        self.available_cameras = []
        self.vision_thread = None
```

### کلاس VisionThread
```python
class VisionThread(QThread):
    frame_ready = pyqtSignal(QImage)
    key_pressed = pyqtSignal(str)
    error_occurred = pyqtSignal(str)
```

### ویژگی‌ها
- **Hand Detection**: تشخیص دست با MediaPipe
- **Virtual Keyboard**: کیبورد مجازی
- **Gesture Recognition**: تشخیص حرکات
- **Real-time Processing**: پردازش زنده

### کیبورد مجازی
```python
keys = [
    ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
    ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
    ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
    ['z', 'x', 'c', 'v', 'b', 'n', 'm'],
    ['(', ')', '"', "'", 'SE', 'ET', 'BC']
]
```

### کلیدهای ویژه
- **SE**: Space (فاصله)
- **ET**: Enter (خط جدید)
- **BC**: Backspace (حذف)

---

## همکاری آنلاین

### WebSocket Connection
```python
self.socket = QWebSocket()
self.socket.connected.connect(self.on_connected)
self.socket.textMessageReceived.connect(self.on_message_received)
```

### ویژگی‌ها
- **Real-time Collaboration**: همکاری زنده
- **Auto-reconnection**: اتصال مجدد خودکار
- **Error Handling**: مدیریت خطاهای شبکه
- **Message Broadcasting**: ارسال پیام به همه

### مدیریت اتصال
```python
def retry_connection(self):
    if not self.connected and self.connection_retry_count < self.max_retries:
        self.socket.open(QUrl("ws://server:port"))
```

---

## نکات فنی مهم

### 1. Thread Safety
- استفاده از QMutex برای محافظت از منابع مشترک
- ارسال سیگنال‌ها بین thread ها
- جلوگیری از race conditions

### 2. Resource Management
- بستن خودکار فایل‌ها
- آزادسازی منابع دوربین
- مدیریت حافظه

### 3. Error Recovery
- تلاش مجدد برای عملیات ناموفق
- نمایش پیام‌های کاربرپسند
- ثبت خطاها برای عیب‌یابی

### 4. Performance Optimization
- کش کردن نتایج
- پردازش در thread های جداگانه
- بهینه‌سازی UI updates

### 5. Internationalization
- پشتیبانی کامل از فارسی
- RTL support
- فونت‌های مناسب

---

## نحوه استفاده

### راه‌اندازی
```python
python main.py --gui
```

### تنظیمات اولیه
1. نصب فونت‌های فارسی
2. تنظیم API key برای AI
3. اتصال دوربین (برای vision)
4. تنظیم سرور همکاری

### ویژگی‌های کلیدی
- **Code Editor**: ویرایش کد با syntax highlighting
- **AI Assistant**: کمک هوش مصنوعی
- **Vision Typing**: تایپ با حرکات دست
- **Project Management**: مدیریت پروژه‌ها
- **Collaboration**: همکاری آنلاین
- **Git Integration**: مدیریت کد

---

## عیب‌یابی

### مشکلات رایج
1. **فونت فارسی نمایش داده نمی‌شود**
   - نصب فونت‌های فارسی
   - اجرای font_setup.py

2. **خطای اتصال به AI**
   - بررسی API key
   - بررسی اتصال اینترنت

3. **دوربین کار نمی‌کند**
   - بررسی اتصال دوربین
   - نصب OpenCV و MediaPipe

4. **خطای WebSocket**
   - بررسی آدرس سرور
   - بررسی پورت

### Log Files
- `codeprime.log`: لاگ اصلی برنامه
- `sessions_log.txt`: لاگ جلسات کاری

---

## توسعه و سفارشی‌سازی

### افزودن تب جدید
```python
def create_new_tab(self):
    new_tab = QWidget()
    # اضافه کردن محتوا
    self.tabs.addTab(new_tab, "نام تب")
```

### افزودن کلید میانبر
```python
shortcut = QShortcut(QKeySequence("Ctrl+N"), self)
shortcut.activated.connect(self.new_function)
```

### تغییر استایل
```python
self.setStyleSheet("""
    QMainWindow {
        background-color: #f0f0f0;
    }
""")
```

---

این راهنما تمام جنبه‌های فنی ابزار CodePrime را پوشش می‌دهد و برای توسعه‌دهندگان و کاربران پیشرفته طراحی شده است. 